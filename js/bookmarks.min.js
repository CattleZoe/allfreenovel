const fcn_jumpToBookmarkButtons=_$$(".button--bookmark"),fcn_mobileBookmarkJump=_$$$("mobile-menu-bookmark-jump"),fcn_mobileBookmarkList=_$(".mobile-menu__bookmark-list"),fcn_mobileBookmarkTemplate=_$("#mobile-bookmark-template"),fcn_bookmarksSmallCardBlock=_$(".bookmarks-block"),fcn_bookmarksSmallCardTemplate=_$(".bookmark-small-card-template");var fcn_bookmarks,fcn_userBookmarksTimeout;function fcn_initializeLocalBookmarks(){fcn_setBookmarks(fcn_bookmarks=fcn_getBookmarks(),!0),fcn_updateBookmarksView()}function fcn_initializeUserBookmarks(o){fcn_setBookmarks(JSON.parse(o.detail.data.bookmarks),!0),fcn_updateBookmarksView()}function fcn_getBookmarks(){return fcn_parseJSON(localStorage.getItem("fcnChapterBookmarks"))??{data:{}}}function fcn_setBookmarks(o,e=!1){if("object"==typeof o){if(fcn_bookmarks=o,localStorage.setItem("fcnChapterBookmarks",JSON.stringify(o)),fcn_isLoggedIn){const e=fcn_getUserData();e&&(e.bookmarks=JSON.stringify(o),fcn_setUserData(e))}e||fcn_saveUserBookmarks(JSON.stringify(o))}}function fcn_updateBookmarksView(){if(!fcn_bookmarks)return;const o=_$(".profile-bookmarks-stats"),e=Object.keys(fcn_bookmarks.data).length;o&&(o.innerHTML=o.innerHTML.replace("%s",e)),e>0&&_$$(".icon-menu-bookmarks").forEach((o=>{o.classList.remove("hidden")})),fcn_showBookmarkCards(),fcn_showChapterBookmark()}function fcn_saveUserBookmarks(o){fcn_isLoggedIn&&(clearTimeout(fcn_userBookmarksTimeout),fcn_userBookmarksTimeout=setTimeout((()=>{fcn_ajaxPost({action:"fictioneer_ajax_save_bookmarks",fcn_fast_ajax:1,bookmarks:o}).then((o=>{o.data.error&&fcn_showNotification(o.data.error,3,"warning")})).catch((o=>{o.status&&o.statusText&&fcn_showNotification(`${o.status}: ${o.statusText}`,3,"warning")}))}),fictioneer_ajax.post_debounce_rate))}function fcn_toggleBookmark(o,e="none"){fcn_bookmarks=fcn_getBookmarks();const a=_$(".chapter__article"),r=_$(".current-bookmark");if(!a)return;const t=fcn_bookmarks.data[a.id];if(t&&t["paragraph-id"]==o&&r)"none"!=e&&e!=t.color?(_$(".current-bookmark").dataset.bookmarkColor=e,t.color=e):fcn_removeBookmark(a.id);else{Object.keys(fcn_bookmarks.data).length>=50&&fcn_removeBookmark(Object.keys(fcn_bookmarks.data)[0]);const t=_$(`[data-paragraph-id="${o}"]`),k=_$$$("chapter-bookmark-data").dataset;fcn_bookmarks.data[a.id]={"paragraph-id":o,progress:100*(fcn_offset(t).top-fcn_offset(t.parentElement).top)/t.parentElement.clientHeight,date:new Date,color:e,chapter:k.title.trim(),link:k.link,thumb:k.thumb,image:k.image,story:k.storyTitle.trim(),content:t.querySelector("span").innerHTML.substring(0,128)+"â€¦"},fcn_jumpToBookmarkButtons.forEach((o=>{o.classList.remove("hidden")})),fcn_mobileBookmarkJump?.removeAttribute("hidden"),r?.classList.remove("current-bookmark"),t.classList.add("current-bookmark"),t.setAttribute("data-bookmark-color",e)}fcn_setMobileMenuBookmarks(),fcn_setBookmarks(fcn_bookmarks)}function fcn_showChapterBookmark(){_$(".current-bookmark")?.classList.remove("current-bookmark");const o=_$(".chapter__article");if(!o||!fcn_bookmarks.data[o.id])return;const e=fcn_bookmarks.data[o.id]["paragraph-id"],a=_$(`[data-paragraph-id="${e}"]`),r=fcn_bookmarks.data[o.id].color??"none";e&&a&&(fcn_jumpToBookmarkButtons.forEach((o=>{o.classList.remove("hidden")})),fcn_mobileBookmarkJump?.removeAttribute("hidden"),a.classList.add("current-bookmark"),a.setAttribute("data-bookmark-color",r))}function fcn_setMobileMenuBookmarks(){if(fcn_mobileBookmarkList.innerHTML="",Object.keys(fcn_bookmarks.data).length>0)Object.entries(fcn_bookmarks.data).forEach((o=>{const e=fcn_mobileBookmarkTemplate.content.cloneNode(!0);e.querySelector(".mobile-menu__bookmark").classList.add(`bookmark-${o[0]}`),e.querySelector(".mobile-menu__bookmark").dataset.color=o[1].color,e.querySelector(".mobile-menu__bookmark-progress > div > div").style.width=`${o[1].progress.toFixed(1)}%`,e.querySelector(".mobile-menu__bookmark a").href=`${o[1].link}#paragraph-${o[1]["paragraph-id"]}`,e.querySelector(".mobile-menu__bookmark a span").innerText=o[1].chapter,e.querySelector(".mobile-menu-bookmark-delete-button").setAttribute("data-bookmark-id",`${o[0]}`),fcn_mobileBookmarkList.appendChild(e)})),fcn_bookmarkDeleteHandler(_$$(".mobile-menu-bookmark-delete-button"));else{const o=document.createElement("li");o.classList.add("no-bookmarks"),o.appendChild(document.createTextNode(fcn_mobileBookmarkList.dataset.empty)),fcn_mobileBookmarkList.appendChild(o)}}function fcn_showBookmarkCards(){if(!fcn_bookmarks||!fcn_bookmarksSmallCardBlock||!fcn_bookmarksSmallCardTemplate||Object.keys(fcn_bookmarks.data).length<1||_$(".bookmark-card"))return;fcn_bookmarksSmallCardBlock.classList.remove("hidden"),_$(".bookmarks-block__no-bookmarks")?.remove(),_$$(".show-if-bookmarks").forEach((o=>{o.classList.remove("hidden")}));let o=fcn_bookmarksSmallCardBlock.dataset.count;Object.entries(fcn_bookmarks.data).forEach((e=>{if(o>-1&&o--<1)return;const a=fcn_bookmarksSmallCardTemplate.content.cloneNode(!0),r=new Date(e[1].date);""!==e[1].image?(a.querySelector(".bookmark-card__image").href=e[1].image,a.querySelector(".bookmark-card__image img").src=`${e[1].thumb}`):a.querySelector(".bookmark-card__image").remove(),a.querySelector(".bookmark-card__excerpt").innerHTML+=e[1].content,a.querySelector(".bookmark-card").classList.add(`bookmark-${e[0]}`),a.querySelector(".bookmark-card").dataset.color=e[1].color,a.querySelector(".bookmark-card__title > a").href=`${e[1].link}#paragraph-${e[1]["paragraph-id"]}`,a.querySelector(".bookmark-card__title > a").innerText=e[1].chapter,a.querySelector(".bookmark-card__percentage").innerText=`${e[1].progress.toFixed(1)} %`,a.querySelector(".bookmark-card__progress").style.width=`${e[1].progress.toFixed(1)}%`,a.querySelector("time").innerText=`${r.toLocaleDateString("en-US",{year:"2-digit",month:"short",day:"numeric"})}`,a.querySelector(".button-delete-bookmark").setAttribute("data-bookmark-id",`${e[0]}`),fcn_bookmarksSmallCardBlock.querySelector("ul").appendChild(a)})),fcn_bookmarkDeleteHandler(_$$(".button-delete-bookmark"))}function fcn_bookmarkDeleteHandler(o){("object"==typeof o?o:[o]).forEach((o=>{o.addEventListener("click",(o=>{fcn_removeBookmark(o.currentTarget.dataset.bookmarkId),fcn_setBookmarks(fcn_bookmarks),Object.keys(fcn_bookmarks.data).length<1&&(_$(".bookmarks-block")?.classList.add("hidden"),_$$(".show-if-bookmarks").forEach((o=>{o.classList.add("hidden")})))}))}))}function fcn_removeBookmark(o){const e=_$(".chapter__article"),a=_$(".current-bookmark");delete fcn_bookmarks.data[o],e&&e.id==o&&(fcn_jumpToBookmarkButtons.forEach((o=>{o.classList.add("hidden")})),fcn_mobileBookmarkJump?.setAttribute("hidden",!0),a&&(a.classList.remove("current-bookmark"),a.removeAttribute("data-bookmark-color"))),_$$(`.bookmark-${o}`)?.forEach((o=>{o.remove()}))}fcn_initializeLocalBookmarks(),document.addEventListener("fcnUserDataReady",(o=>{fcn_initializeUserBookmarks(o)})),fcn_jumpToBookmarkButtons.forEach((o=>{o.addEventListener("click",(()=>{fcn_scrollTo(_$(`[data-paragraph-id="${fcn_bookmarks.data[_$("article").id]["paragraph-id"]}"]`))}))}));